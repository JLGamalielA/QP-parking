/*! For license information please see qr-reader.js.LICENSE.txt */
(()=>{function e(){var n,r,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",c=a.toStringTag||"@@toStringTag";function i(e,a,o,c){var i=a&&a.prototype instanceof u?a:u,d=Object.create(i.prototype);return t(d,"_invoke",function(e,t,a){var o,c,i,u=0,d=a||[],l=!1,f={p:0,n:0,v:n,a:p,f:p.bind(n,4),d:function(e,t){return o=e,c=0,i=n,f.n=t,s}};function p(e,t){for(c=e,i=t,r=0;!l&&u&&!a&&r<d.length;r++){var a,o=d[r],p=f.p,v=o[2];e>3?(a=v===t)&&(i=o[(c=o[4])?5:(c=3,3)],o[4]=o[5]=n):o[0]<=p&&((a=e<2&&p<o[1])?(c=0,f.v=t,f.n=o[1]):p<v&&(a=e<3||o[0]>t||t>v)&&(o[4]=e,o[5]=t,f.n=v,c=0))}if(a||e>1)return s;throw l=!0,t}return function(a,d,v){if(u>1)throw TypeError("Generator is already running");for(l&&1===d&&p(d,v),c=d,i=v;(r=c<2?n:i)||!l;){o||(c?c<3?(c>1&&(f.n=-1),p(c,i)):f.n=i:f.v=i);try{if(u=2,o){if(c||(a="next"),r=o[a]){if(!(r=r.call(o,i)))throw TypeError("iterator result is not an object");if(!r.done)return r;i=r.value,c<2&&(c=0)}else 1===c&&(r=o.return)&&r.call(o),c<2&&(i=TypeError("The iterator does not provide a '"+a+"' method"),c=1);o=n}else if((r=(l=f.n<0)?i:e.call(t,f))!==s)break}catch(e){o=n,c=1,i=e}finally{u=1}}return{value:r,done:l}}}(e,o,c),!0),d}var s={};function u(){}function d(){}function l(){}r=Object.getPrototypeOf;var f=[][o]?r(r([][o]())):(t(r={},o,function(){return this}),r),p=l.prototype=u.prototype=Object.create(f);function v(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,t(e,c,"GeneratorFunction")),e.prototype=Object.create(p),e}return d.prototype=l,t(p,"constructor",l),t(l,"constructor",d),d.displayName="GeneratorFunction",t(l,c,"GeneratorFunction"),t(p),t(p,c,"Generator"),t(p,o,function(){return this}),t(p,"toString",function(){return"[object Generator]"}),(e=function(){return{w:i,m:v}})()}function t(e,n,r,a){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}t=function(e,n,r,a){function c(n,r){t(e,n,function(e){return this._invoke(n,r,e)})}n?o?o(e,n,{value:r,enumerable:!a,configurable:!a,writable:!a}):e[n]=r:(c("next",0),c("throw",1),c("return",2))},t(e,n,r,a)}function n(e,t,n,r,a,o,c){try{var i=e[o](c),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,a)}function r(e){return function(){var t=this,r=arguments;return new Promise(function(a,o){var c=e.apply(t,r);function i(e){n(c,a,o,i,s,"next",e)}function s(e){n(c,a,o,i,s,"throw",e)}i(void 0)})}}var a=0,o=null,c=null,i=function(e,t){var n=e.querySelector("i")||e.querySelector("svg"),r=e.querySelector("span");!function(e,t){var n=document.querySelector('.reader-status-text[data-entry-id="'.concat(e,'"]'));n&&(t?(n.textContent="Activo",n.classList.remove("text-warning"),n.classList.add("text-success")):(n.textContent="Inactivo",n.classList.remove("text-success"),n.classList.add("text-warning")))}(e.dataset.entryId,t),t?(e.dataset.qrActive="1",e.classList.remove("text-success"),e.classList.add("text-warning"),r&&(r.textContent="Desactivar"),n&&(n.className="fa-solid fa-xmark me-2")):(e.dataset.qrActive="0",e.classList.remove("text-warning"),e.classList.add("text-success"),r&&(r.textContent="Activar"),n&&e.dataset.originalIcon&&(n.className=e.dataset.originalIcon))},s=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=document.getElementById("qr-output");n&&(n.textContent=e,n.className=t?"mt-3 px-3 text-center fw-bold text-danger":"mt-3 px-3 text-center fw-bold text-success")},u=function(){var t=r(e().m(function t(){var n,r,a,c,u,d;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:if(o){e.n=1;break}return e.a(2);case 1:if(r=(n=o).button,a=n.port,c=n.reader,u=n.inputDone,o.stopRequested=!0,e.p=2,!c){e.n=4;break}return e.n=3,c.cancel();case 3:c.releaseLock();case 4:if(!u){e.n=5;break}return e.n=5,u.catch(function(){});case 5:if(!a){e.n=6;break}return e.n=6,a.close();case 6:e.n=8;break;case 7:e.p=7,d=e.v,console.warn("Error closing scanner resources:",d);case 8:return e.p=8,i(r,!1),o=null,s(""),e.f(8);case 9:return e.a(2)}},t,null,[[2,7,8,9]])}));return function(){return t.apply(this,arguments)}}(),d=function(){var t=r(e().m(function t(n,r,a,o,c){var i,u,d,l,f,p,v;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!(n.length<1)){e.n=1;break}return e.a(2);case 1:return s("Procesando código...",!1),e.p=2,e.n=3,fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":c,Accept:"application/json"},body:JSON.stringify({code:n,parking_id:a,entry_id:o})});case 3:return i=e.v,e.n=4,i.json();case 4:u=e.v,i.ok&&u.ok?"exitToken"===u.data.action?s("Éxito: Salida registrada.",!1):"exit"===u.data.action?(d=u.data,l="Salida Exitosa. Usuario: ".concat(d.code,". Hora de salida: ").concat(d.exit_time,". Cobrado: $").concat(d.amount_paid,". Crédito restante: $").concat(d.new_credit),s(l,!1)):(f=(new Date).toLocaleTimeString(),s("Éxito: Entrada registrada. Usuario: ".concat(u.data.code," a las ").concat(f),!1)):(p=u.error||u.message||u.data&&u.data.error||"Error desconocido",s("Error: ".concat(p),!0)),e.n=6;break;case 5:e.p=5,v=e.v,console.error("API Communication Error:",v),s("Error de comunicación con el servidor.",!0);case 6:return e.a(2)}},t,null,[[2,5]])}));return function(e,n,r,a,o){return t.apply(this,arguments)}}(),l=function(){var t=r(e().m(function t(n){var l,f,p,v,b,m,y,g,h,x,k,w,S,q,E,T;return e().w(function(t){for(;;)switch(t.p=t.n){case 0:if("1"!==n.dataset.qrActive){t.n=2;break}return t.n=1,u();case 1:return t.a(2);case 2:if(!o||o.button===n){t.n=3;break}return t.n=3,u();case 3:if(f=n.dataset.storeUrl,p=n.dataset.parkingId,v=n.dataset.entryId,b=(null===(l=document.querySelector('meta[name="csrf-token"]'))||void 0===l?void 0:l.getAttribute("content"))||"",f&&p&&v){t.n=4;break}return console.error("Missing data attributes on scanner button"),t.a(2);case 4:if(t.p=4,!c){t.n=5;break}m=c,t.n=7;break;case 5:return t.n=6,navigator.serial.requestPort();case 6:m=t.v,c=m;case 7:return t.n=8,m.open({baudRate:9600});case 8:y=new TextDecoderStream,g=m.readable.pipeTo(y.writable),h=y.readable,x=h.getReader(),i(n,!0),s("Lector conectado. Esperando código...",!1),o={button:n,port:m,reader:x,inputDone:g,stopRequested:!1},k="",w=null,S=function(){var t=r(e().m(function t(){var n,r;return e().w(function(e){for(;;)switch(e.n){case 0:if(!(k.length>0)){e.n=1;break}if(n=k.replace(/[\x00-\x1F\x7F]/g,"").trim(),k="",!(n.length>0)){e.n=1;break}if(!((r=Date.now())-a>3e3)){e.n=1;break}return a=r,e.n=1,d(n,f,p,v,b);case 1:return e.a(2)}},t)}));return function(){return t.apply(this,arguments)}}();case 9:if(!o||o.stopRequested||o.button!==n){t.n=15;break}return t.n=10,x.read();case 10:if(q=t.v,E=q.value,!q.done){t.n=11;break}return t.a(3,15);case 11:if(!E){t.n=14;break}if(w&&clearTimeout(w),!(k+=E).includes("\n")&&!k.includes("\r")){t.n=13;break}return t.n=12,S();case 12:t.n=14;break;case 13:w=setTimeout(r(e().m(function t(){return e().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,S();case 1:return e.a(2)}},t)})),300);case 14:t.n=9;break;case 15:t.n=17;break;case 16:return t.p=16,T=t.v,console.error("Scanner System Error:",T),alert("No se pudo conectar al lector. Verifique permisos y conexión USB."),t.n=17,u();case 17:return t.a(2)}},t,null,[[4,16]])}));return function(e){return t.apply(this,arguments)}}(),f=function(){var e=document.querySelectorAll(".btn-activate-reader");0!==e.length&&e.forEach(function(e){if("true"!==e.dataset.bound){e.dataset.bound="true",e.dataset.qrActive="0";var t=e.querySelector("i")||e.querySelector("svg");t&&(e.dataset.originalIcon=t.className),e.addEventListener("click",function(){return l(e)})}})};document.addEventListener("DOMContentLoaded",function(){f()}),window.initScannerBinding=f})();